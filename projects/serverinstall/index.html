<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>home server based on Ubuntu 20.04 with ZFS</title>
	<meta name="Ubuntu home server" content="home server based on Ubuntu 20.04 with ZFS">
<!--	<link href="../../design.css" rel="stylesheet">-->
</head>

<body>
	<h1>home server based on Ubuntu 20.04 with ZFS</h1>
	<p>
		Just as information:<br/>
		Up to now this page is just a collection of what I do to setup
		my server. Therefor the design of these pages is not nice. It's
		more or less my reminder for what to do during a new
		installation.
	</p>
	<p>
		I am running a home server since many years.
		Somewhere around 2018 I deciced to switch to a new server
		using ZFS as filesystem. At that time I started with a
		combination of several howtos I found in the internet. That
		was a lot of work and I have no chance to list all of the
		sources as each of them only solved one step of the whole
		story.
	</p>

	<p>
		Now, beginning with Ubuntu 20.04, Canonical added
		(experimental) support of Ubuntu installation on ZFS. Therefore
		I decided to do a clean new installation of my server.
		Additionally I decided to create a documentation of each step I
		do - maybe it is usefull for other people, too
	</p>

	<p>
		So just feel free to follow my steps.
	</p>

	<h2>Preconditions</h2>
	<p>
		I don't want to use new hardware, but I have available:
	</p>
	<ul>
		<li>Mainboard: ASROCK B85M-ITX</li>
		<li>Pentium G3440T</li>
		<li>128G SSD for booting</li>
		<li>4 harddisks as raid for data</li>
	</ul>
	<p>
		I personally prefer xubuntu, so I also need a bootable xubuntu
		20.04 USB stick.
	</p>

	<h3>work in progress</h3>
	<p>
		The mainboard provides four SATA ports and an ESATA port. My
		actually running server has the SSD connected to the ESATA port.
		In the future I want to free the ESATA port again. Therefore
		I have two possibilities:
	</p>
	<ul>
		<li>use an already available USB3 to SATA converter</li>
		<li>buy a PCIE SATA controller</li>
	</ul>
	<p>
		I do the actual tries with the USB3 adapter - just because I
		have it available. Up to now I face no differnce between having
		the	SSD connected to SATA or to USB - the installation process
		is the same.
	<p><h4>News about this point</h4>
	</p>
		I found a pretty nice SATA controller for my needs:<br/>
		<a href="https://www.delock.de/produkt/90396/merkmale.html">PCIe card 4 sata plus M.2</a><br/>
		It's already ordered and I'll write my experience here.<br/>
		Having in mind that I own a second housing with 4 hard disc slots this opens even more possibilities :-)
	</p>

	<p>
		Actually I'm setting up the new environment so the whole thing
		is work in progress.
	</p>

	<h3>Things to know</h3>
	<p>Just to point it out:</p>
	<ul>
		<li>
			I know that having the boot data not on the redundant
			system leads to non accessable data in the case the boot
			device fails or gets corrupted. But I prefer having a fast
			boot process and in the situation of a failing device I
			have to do a desaster recovery of the boot device.
		</li>
		<li>
			I also know that booting from USB is not as relaiable than
			booting	from a SATA device. It may happen that I buy a PCIE
			SATA adapter to solve this issue.
		</li>
		<li>
			Additionally I also know that the used mainboard doesn't
			support ECC RAM and therefore is not as reliable as a
			professional server. But hey, this is a home server,
			not a professional one.
		</li>
	</ul>

	<h2>Requirements</h2>
	<ul>
		<li>
			In normal case the server shall be off. I don't like current
			consumption when it is not in use.
		</li>
		<li>
			On request it shall be available FAST. So I want to use
			suspend to RAM.
		</li>
		<li>
			On power fail everything shall work smooth, so suspend to
			RAM is not enough - the shutdown has to do a disk image,
			too.
		</li>
		<li>
			The system has to provide Wake On Lan - I don't want to
			push the button.
		</li>
		<li>
			The supension shall be done automatically after some
			minutes of idletime
		</li>
	</ul>

	<h2>Already known issues</h2>
	<ul>
		<li>
			(solved) during ubuntu 20.04 installation there is no
			possibility to define the partition layout or to create
			data pools with redundancy
		</li>
		<li>
			(solved) the mainboard is equipped with a Qualcomm Atheros
			AR8171 gigabit ethernet chip. This chip supports Wake On
			Lan, but you have to tweak the linux system to enable it
		</li>
		<li>
			(solved) the ubuntu partitioning when using the
			installation on ZFS creates a 2G swap partition. This is
			not large enough for suspend to disk
		</li>
	</ul>

	<h2>Creating the USB boot medium</h2>
	<p>
		I propose to use <a href="www.ventoy.net">Ventoy</a>. It's
		available for Linux and Windows.<br/>
		This page explains the usage of ventoy under linux.<br/>
		Usage under Windows is explained on the website.<br/>
		The configuration of the stick content is identical.
	</p>

	<h3>Download ventoy</h3>
	<p>
		Download the tool here:<br/>
		<a href="https://github.com/ventoy/Ventoy/releases">Ventoy download from Github</a><br/>
		You'll get a file "ventoy-x.y.z-linux.tar.gz" with x, y, and z
		digits for the version.
	</p>
	<p>
		Optional: check the SHA256 against the value given on the
		website.<br/>
		<code>sha256sum ventoy-x.y.z-linux.tar.gz</code><br/>
		and compare the value.<br/>
		don't forget to use the <em>real</em> filename
	</p>
	<p>
		Extract the file with the command<br/>
		<code>tar -xaf ventoy-x.y.z-linux.tar.gz</code><br/>
		don't forget to use the <em>real</em> filename
	</p>

	<h3>Create bootable USB stick</h3>
	<p>
		cd into the extracted directory<br/>
		<code>cd ventoy-x.y.z</code><br/>
		don't forget to use the <em>real</em> directory name
	</p>
	<p>
		Insert an USB stick with enough space for the ubuntu iso file
		plus a file for persistent data. I recommend to use a stick
		with at least 8GB.<br/>
	</p>
	<p>
		run ventroy with the command<br/>
		<code>sudo sh Ventoy2Disk.sh -I /dev/XXX</code><br/>
		Replace XXX by the device name of your USB stick.
	</p>
	<p>
		Your computer will remount the stick and show one partition
		named<br/>
		<code>ventoy</code>
	</p>
	<p>
		Copy your ubuntu iso file on this USB stick.<br/>
		Now the stick is bootable, but we need the possibility to
		modify files on the stick persistent.
	</p>

	<h3>Create persistent data area on the stick</h3>
	<p>
		ventoy contains a plugin for persistent data creation on
		bootable USB sticks. To prapare this execute the command<br/>
		<code>sudo sh CreatePersistentImg.sh -s 1024 -t ext4 -l casper-rw</code>
	</p>
	<p>
		This creates a file <code>persistence.dat</code> in your actual
		directory.<br/>
		Copy the file on the stick.
	</p>
	<p>
		Now we have to tell ventoy to use this persistence file for
		booting ubuntu.<br/>
		To do so create a directory <code>ventoy</code>
		on the USB stick.
	</p>
	<p>
		Create a file <code>ventoy.json</code> in this directory.<br/>
		Content of this file has to be:
	</p>
	<pre>
{
    "persistence": [
        {
            "image": "/xubuntu-20.04.1-desktop-amd64.iso",
            "backend": "/persistence.dat",
            "autosel": 1
        }
    ]
}
	</pre>
	<p>
		You can adapt the file names to your needs. It's also possible
		to rename <code>persistence.dat</code>, in that case use the
		new filename in <code>ventoy.json</code>, too.
	</p>

	<h3>Preparing the partitioning script on the boot medium</h3>
	<p>
		As mentioned above the default partitioning script of the
		ubuntu installation medium creates a swap partition of 2G.
		If the system shall do suspend to disk the swap partition is
		used to store the complete RAM content. Knowing this leads to
		the conclusion that 2G is - in most case - much to small.
	</p>
	<p>
		As solution I first do a modification on the USB stick. The
		stick creation process explained above leads to a persistent
		storage in that boot system. So I boot the live stick and
		change the required file. Since then this modified file is used
		for partitioning.
	</p>
	<p>
		After booting your future server system from the USB stick
		with "Try without installation" patch the file<br/>
		<code>/usr/share/ubiquity/zsys-setup</code><br/>
		with root rights using this patch file:
		<a href="zsys-setup.patch">zsys-setup.patch</a>
	</p>
	<p>
		to patch the file open a terminal and type<br/>
		<code>wget https://Andiweiss.github.io/projects/serverinstall/zsys-setup.patch</code><br/>
		<code>cd /usr/share/ubiquity</code><br/>
		<code>sudo patch -p1 /home/xubuntu/zsys-setup.patch</code>
	</p>
	<p>
		This patch modifies the zfs initialization script in a way that
		an additional zfs pool with the name "tank" is created.
		This tank will be used to create the directories<br/>
		<code>/home /srv /var/www</code>
	</p>
	<p>
		After applying the patch there are two new lines near the top:<br/>
		<code>TANKDEVICES="..."</code><br/>
		<code>TANKMODE=""</code><br/>
		In <code>TANKDEVICES</code> you can add a list of hard disks or
		partitions whih shall be used for that data tank.<br/>
		In <code>TANKMODE</code> you have to define how these devices
		shall be combined. Here you can either leave the variable empty
		or use <code>mirror</code>, <code>raidz</code> or <code>raidz2</code>.
	</p>
	<p>
		Please check the zfs documentation what these modes do.
	</p>
	<p>
		Recommendation for the device list:<br/>
		<em>DO NOT</em> use <code>/dev/sd?</code><br/> here.
		Use <code>/dev/disk/by-id</code> or any other of these by-*
		directories - whatever fits your usage.
	</p>
	<p>
		After saving this change the stick is prepared for installation.
		You can start the installation either with a new boot or without
		rebooting by using the install ubuntu icon.
	</p>
	<p>
		If you regulary work in Linux it's easy to have a look on that
		file on another linux machine. After saving the file in the
		life system shut down the life system and connect the USB stick
		to your working linux system. In a default environment your
		system will mount the stick under <code>/media/&lt;user&gt;/ventoy</code>
	</p>
	<p>
		create a directory for temporary mounting of the persitence file<br/>
		<code>mkdir pers</code>
	</p>
	<p>
		Now mount the persistence file<br/>
		<code>sudo mount /dev/media/&lt;user&gt;/ventoy/persistence.dat</code><br/>
		In the case that you have chosen a different filename use that one.
	</p>
	<p>
		Now you have access to your modified zsys-setup. You find it in<br/>
		<code>pers/upper/usr/share/ubiquity/zsys-setup</code>
	</p>

	<h2>Starting the installation</h2>
	<p>
		Do the installation in the regular way. Just keep care for one
		Window:
	</p>
	<p>
		In the Window "Installation type" you have to chose "Advanced
		Features ...". In the now opened window select "EXPERIMENTAL:
		Erase disk and use ZFS". Then select the device you want to boot
		from.
	</p>
	<p>
		Now let the installer do its work. After that you'll have an
		ubuntu system on one hard disk using ZFS wherever it is
		possible. There's only one partition with another file system.
		The EFI partition must not be converted to ZFS. This one has
		to stay on VFAT.
	</p>

	<h2>Small configuration issues</h2>
	<p>
		After the ubuntu installation process is finished we have a
		clean installation waiting for further configuration. This is
		mainly one thing I do not like:<br/>
		There are icons for rpool and bpool on the desktop I want to
		get rid of.
	</p>
	<p>
		To get rid of these icons we have to enter two lines in<br/>
		<code>/etc/fstab</code>
	</p>
	<p>
		This file has to be editied with root rights. Just add the two
		lines<br/>
		<code>LABEL=rpool	none	auto	noauto	0	0</code><br/>
		<code>LABEL=bpool	none	auto	noauto	0	0</code>
	</p>
	<p>
		One thing I really like is the possibility to use pageup /
		pagedown for searching the history. This is enabled in<br/>
		<code>/etc/inputrc</code>
	</p>
	<p>
		As last little config issue I disable the bluetooth service. It
		usually crashes during boot and I don't have a bluetooth device
		connected to the server.<br/>
		<code>sudo systemctl disable bluetooth</code>
	</p>

	<h2>Configuration of suspend and hibernate</h2>
	<p>
		No the basics are done. We have a system booting from ZFS and
		the desktop is clean.
	</p>
	<p>
		The next step to do is the configuration of suspend to RAM and
		suspend to disk.
	</p>
	<p>
		To get supend, hibernate and a combination of both full
		functional we just have to install one official ubuntu package:<br/>
		<code>sudo apt install uswsusp</code>
	</p>
	<p>
		Having this package installed there is nothing to say against a
		test of suspend to ram, disk or both.
	</p>
	<p>
		To test suspend to RAM execute the command<br/>
		<code>sudo s2ram</code>
	</p>
	<p>
		If everything is fine the system shuts down very fast.
		At least my system wakes up with hitting any key on the
		keyboard. Everything is fine if you don't get the regular login
		but the screen saver password request.
	</p>
	<p>
		Next try is suspend to disk. The command for doing that is<br/>
		<code>sudo s2disk</code>
	</p>
	<p>
		In this case shuting down needs a bit more time and the system
		prints additional information on the screen where the image is
		stored and how large it is. On boot it takes the bios time,
		then loads the image and again there should be the screensaver
		password request. If you get the regular login screen something
		went wrong.
	</p>
	<p>
		Last test for me is testing if the combination suspend to RAM
		and to disk is also working fine. The related command is<br/>
		<code>sudo s2both</code>
	</p>
	<p>
		After this the shut down looks simular as in s2disk. Shutting
		down needs the same time as in s2disk. But as long as you don't
		pull the power cord the system will start up in the same time
		as with s2disk.<br/>
		<em>If</em> you pull the power cord and plug it again the system
		will again recover in the same state where you entered s2both.
	</p>
	<p>
		to have this as a sensefull feature you have to setup your BIOS
		in the way that after power loss the computer starts up. In most
		cases the default for this setting is "keep it off".
	</p>

	<h2>Configuration of Wake On Lan</h2>
	<p>
		As already explained in the prerequesites the Atheros AR8171 in
		principle supports Wake On Lan, but it is completely disabled
		in the ubuntu standard installation. So we're going to activate
		it now.
	</p>
	<p>
		First thing to do is to install ethtool:<br/>
		<code>sudo apt install ethtool</code>
	</p>
	<p>
		Now we need to know which interface we want to configure:<br/>
		<code>ip link</code><br/>
		We identify the interface, in my case this is <code>enp2s0</code>
	</p>
	<p>
		Next step is to check the supported wake on lan modes and the
		actually configured ones:<br/>
		<code>sudo ethtool enp2s0 | grep Wake-on</code>
	</p>
	<p>
		On my server hardware this reports:<br/>
		<code>Supports Wake-on: d</code><br/>
		<code>Wake-on: d</code><br/>
	</p>
	<p>
		This is sad, because this means: No Wake On Lan supported ...<br/>
		<em>But:</em> the driver supports WOL, it just has to be
		enabled. This is done by an additional kernel command line
		parameter.
	</p>
	<p>
		To get WOL working on the Atheros AR8171 the kernel requires
		the additional commandline paramter <code>alx.enable_wol=1</code>.
		To add this parameter edit the file <code>/etc/default/grub</code>
		with root rights. Here you find a line<br/>
		<code>GRUB_CMDLINE_LINUX_DEFAULT="&lt;some_parameters&gt;"</code>
	</p>
	<p>
		in this line add <code>alx.enable_wol=1</code> with  leading
		blank in front of the second quotation mark. After doing that
		execute the command<br/>
		<code>sudo update-grub</code><br/>
		to overtake the change.
	</p>
	<p>
		Now execute a reboot, open a terminal and try the command<br/>
		<code>sudo ethtool enp2s0 | grep Wake-on</code><br/>
		again.
	</p>
	<p>
		The new result is:<br>
		<code>Supports Wake-on: pg</code><br/>
		<code>Wake-on: pg</code><br/>
	</p>
	<p>
		So now Wake On Lan is activated on
		<ul>
			<li>phy activity</li>
			<li>MagicPacket</li>
		</ul>
		I don't like phy activity waking up my system, so I have to
		use ethtool to change that behavior. Chaninging it in the
		commandline will be lost after reboot, therefore I add a task
		in systemd.
	</p>
	<p>
		To create that service create the file<br/>
		<code>/etc/systemd/system/wol.service</code><br/>
		with root rights. This file has to contain:
<pre>
[Unit]
Description=Configure Wake-up on LAN

[Service]
Type=oneshot
ExecStart=/sbin/ethtool -s enp2s0 wol g

[Install]
WantedBy=basic.target
</pre>
		Then enable the service with<br/>
		<code>sudo systemctl enable wol.service</code>
	</p>
	<p>
		After a reboot ethtool reports<br/>
		<code>Supports Wake-on: pg</code><br/>
		<code>Wake-on: g</code><br/>
		<em>This</em> is what we want to get.
	</p>
</body>
</html>
